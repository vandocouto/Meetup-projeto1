currentBuild.displayName = "1.0.${BUILD_NUMBER}"
currentBuild.description = "Meetup Churrops"

node ('master') {
    try {
        stage('Slack Notification'){
            notifyBuild('STARTED')
        }

        stage('Fetch') {
            checkout scm
            pollSCM 'H/1 * * * *'
        }

        stage ('Docker Login') {
            withCredentials([string(credentialsId: 'REGISTRY', variable: 'REGISTRY')]) {
                sh "sudo docker login -u churrops -p $REGISTRY registry.churrops.com"
            }
        }

        stage ('Build Container') {
            sh "sudo docker build -f build/Dockerfile -t registry.churrops.com/projeto1:'${currentBuild.displayName}' ."
        }

        stage ('Push Docker Registry'){
            sh "sudo docker push registry.churrops.com/projeto1:'${currentBuild.displayName}'"
        }

        stage ('kubernetes Admin') {
            sshagent(['KubernetesApi']) {
                sh 'ssh -o StrictHostKeyChecking=no ubuntu@api.churrops.com uname -a'
            }
        }
    }
    catch (e) {
        currentBuild.result = "FAILED"
        throw e
    }
    finally {
        notifyBuild(currentBuild.result)
    }
}
